# RGFL Survivor Fantasy League

Comprehensive notes for developing, configuring, and deploying the RGFL Survivor Fantasy League application. This document condenses the previous setup, deployment, and checklist markdown files into a single reference.

---

## 1. Quick Start

### Unix/Linux/macOS
```bash
./setup.sh
```

### Windows
```cmd
setup.bat
```

### What the script does
- Installs dependencies
- Generates the Prisma client
- Applies database schema and seeds baseline data
- Builds both client and server bundles

---

## 2. Manual Local Setup

### Prerequisites
- Node.js 18+
- npm
- Git
- Access to a PostgreSQL database

### Step-by-step
1. **Install dependencies**
   ```bash
   npm install
   ```
2. **Generate Prisma client**
   ```bash
   npx prisma generate
   ```
3. **Configure environment variables** ‚Äì create a `.env` (never commit it):
   ```env
   DATABASE_URL=postgresql://USER:PASSWORD@HOST/DATABASE
   JWT_SECRET=<openssl rand -hex 64>
   CLIENT_ORIGIN=http://localhost:5000
   PORT=5050
   ENABLE_SETUP_ENDPOINT=false
   ```
4. **Apply schema** (destroys existing data when `--force-reset` is used):
   ```bash
   npx prisma db push --force-reset
   ```
5. **Seed sample data**
   ```bash
   npm run db:seed
   ```
6. **Run in development mode**
   ```bash
   npm run dev
   ```

### Available npm scripts
- `npm run dev` ‚Äì Vite + server in watch mode
- `npm run build` ‚Äì Builds client then server
- `npm run build:client` ‚Äì Vite production build
- `npm run build:server` ‚Äì TypeScript -> `dist/server`
- `npm run db:seed` ‚Äì Seeds default league, users, weeks, and castaways
- `npm start` ‚Äì Runs compiled server (`dist/server/index.js`)

---

## 3. Environment Variables

| Variable | Description | Required | Notes |
|----------|-------------|----------|-------|
| `DATABASE_URL` | PostgreSQL connection string | ‚úÖ | Provided automatically on Render when linked to the managed DB |
| `JWT_SECRET` | Used to sign authentication tokens | ‚úÖ | Rotate whenever leaked; 64+ char random hex recommended |
| `CLIENT_ORIGIN` | Comma-separated list of allowed frontends for CORS | ‚úÖ | e.g. `http://localhost:5000,https://rgfl-survivor.onrender.com` |
| `PORT` | Server port | ‚õîÔ∏è (defaults to 5050) | Override when Render assigns a port |
| `ENABLE_SETUP_ENDPOINT` | Allows `/api/setup` reseeding | ‚õîÔ∏è | Leave `false`/unset in production |

> **Tip:** Load `.env` into each shell with `export $(grep -v '^#' .env | xargs)` or use `direnv`.

---

## 4. Database & Seed Data

The Prisma schema defines:
- **User** ‚Äì Authentication, admin flag, relations to picks and scores
- **League** ‚Äì Single league per deployment
- **Castaway** ‚Äì Contestants plus weekly results and picks
- **Week** ‚Äì Episode weeks and active-week flag
- **Pick** ‚Äì User selections per week
- **WeeklyResult** ‚Äì Points awarded per castaway per week
- **Score** ‚Äì Aggregated user scores per week

`npm run db:seed` creates:
- Default league (`RGFL Survivor Fantasy League 2024`)
- 18 Survivor 49 castaways (Kele, Hina, Uli)
- 13 weeks (week 3 active by default)
- Admin user: `admin@rgfl.com` / `admin123`
- Sample user: `user@rgfl.com` / `user123`

---

## 5. JWT-only Authentication

- Login/signup endpoints (`/api/auth/login` & `/api/auth/signup`) issue JWTs.
- Tokens are set as httpOnly cookies and echoed in responses for SPA storage.
- Guarded routes use the Authorization header or cookie token; `express-session` is no longer used.
- To force logout everywhere, rotate `JWT_SECRET` and redeploy.

---

## 6. Deploying to Production

**Live URL:** https://test.realitygamesfantasyleague.com

This project uses the **rgfl_survivor_ml** PostgreSQL database on Render with multi-league support.

### Quick Deploy with Render Blueprint

1. **Push to GitHub**:
   ```bash
   git push origin main
   ```

2. **Deploy via render.yaml**:
   - Log in to [Render Dashboard](https://dashboard.render.com)
   - Click **Blueprints** ‚Üí **New Blueprint Instance**
   - Connect to your GitHub repository
   - Render will automatically read `render.yaml` and create the service

3. **Configure Custom Domain** (test.realitygamesfantasyleague.com):
   - In Render Dashboard ‚Üí Your Service ‚Üí Settings ‚Üí Custom Domains
   - Add `test.realitygamesfantasyleague.com`
   - Update DNS with CNAME record: `test` ‚Üí `rgfl-multi.onrender.com`

### Manual Deploy (Alternative)

1. **Create Web Service**:
   - Environment: `Node`
   - Build Command: `npm install && npx prisma generate && npm run build`
   - Start Command: `npm start`

2. **Environment Variables** (already in render.yaml):
   ```
   NODE_ENV=production
   DATABASE_URL=postgresql://rgfl_survivor_ml_user:***@dpg-d4kbb5k9c44c73erlpp0-a.oregon-postgres.render.com/rgfl_survivor_ml?sslmode=require
   JWT_SECRET=<auto-generated>
   SESSION_SECRET=<auto-generated>
   CLIENT_ORIGIN=https://test.realitygamesfantasyleague.com
   CLIENT_URL=https://test.realitygamesfantasyleague.com
   PORT=5050
   ```

3. **Post-Deployment**:
   - Seed database: `npm run db:seed` (via Render Shell)
   - Create admin: `npx tsx server/scripts/create-admin.ts`

### Deployment Documentation

See [DEPLOYMENT.md](./DEPLOYMENT.md) for comprehensive deployment guide including:
- Environment variable reference
- Post-deployment setup steps
- Custom domain configuration
- Monitoring and troubleshooting
- Rollback procedures

### Database Information

- **Database**: rgfl_survivor_ml (PostgreSQL on Render)
- **Connection**: Already configured in render.yaml
- **Migrations**: Automatically applied via `npx prisma generate` in build
- **Seeding**: Run manually post-deployment or via seed script

### Deployment checklist
- [ ] Database resource created and reachable
- [ ] Environment variables saved (watch for trailing spaces)
- [ ] Build completes without warnings
- [ ] Health check returns 200
- [ ] `/api/auth/login` and `/api/castaways` respond correctly
- [ ] Frontend renders over HTTPS

### Post-deploy verification
1. Login with the seeded admin account and confirm the dashboard loads.
2. Visit protected routes (Weekly Picks, Leaderboard, Admin pages).
3. Confirm `/api/picks/me` respects the active week.
4. Check Render logs for startup errors or missing environment warnings.

---

## 7. Troubleshooting

| Symptom | Likely Cause | Fix |
|---------|--------------|-----|
| Build fails on Render | Missing dependency or TypeScript error | Check build logs, run `npm run build` locally |
| 503 from Prisma | DB unavailable or wrong `DATABASE_URL` | Verify database status and credentials |
| CORS errors in browser | `CLIENT_ORIGIN` missing or incorrect | Add the frontend URL (including protocol) |
| Users stay logged in after secret leak | `JWT_SECRET` not rotated | Generate a new secret, update env vars, redeploy |
| Static files outdated | Forgot to rebuild | Run `npm run build` before deployment |

---

## 8. Support & Next Steps

- Review server logs on Render for runtime diagnostics.
- For reseeding in production, temporarily set `ENABLE_SETUP_ENDPOINT=true`, call `POST /api/setup`, then revert to `false`.
- Keep dependencies patched (`npm outdated`, `npm audit fix`).
- Consider adding automated tests with Vitest (`npm run test`) before future feature deployments.

**You‚Äôre ready to ship Survivor fantasy updates! üèÜ**
