generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Season {
  id            String         @id @default(uuid())
  number        Int            @unique
  name          String
  status        SeasonStatus   @default(COLLECTING)
  episode1Date  DateTime?
  draftDeadline DateTime?
  episode2Date  DateTime?
  finaleDate    DateTime?
  archiveDate   DateTime?
  isActive      Boolean        @default(false)
  rankingsOpen  Boolean        @default(false)
  draftExecuted Boolean        @default(false)
  seasonLocked  Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  castaways     Castaway[]
  draftPicks    DraftPick[]
  leagues       League[]
  picks         Pick[]
  rankings      Ranking[]
  scores        Score[]
  weeks         Week[]
  weeklyResults WeeklyResult[]

  @@index([status])
  @@index([isActive])
  @@index([number])
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  password          String?
  name              String
  username          String?            @unique
  phone             String?            @unique
  phoneVerified     Boolean            @default(false)
  smsEnabled        Boolean            @default(true)
  smsReminders      Boolean            @default(true)
  lastSmsAt         DateTime?
  displayName       String?
  city              String?
  state             String?
  favoriteCastaway  String?
  about             String?
  profilePicture    String?
  isAdmin           Boolean            @default(false)
  leagueId          String?
  resetToken        String?            @unique
  resetTokenExpiry  DateTime?
  hasSeenWelcome    Boolean            @default(false)
  // Charity fields
  favoriteCharity   String? // User's preferred charity name
  charityUrl        String? // Link to charity website
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  draftPicks        DraftPick[]
  feedback          Feedback[]
  leagueMemberships LeagueMembership[]
  picks             Pick[]
  rankings          Ranking[]
  smsLogs           SMSLog[]
  scores            Score[]
  payments          Payment[]
  charityWins       CharityPayout[]
  league            League?            @relation("LegacyLeague", fields: [leagueId], references: [id])

  @@index([isAdmin]) // Fast admin user lookups
  @@index([smsEnabled]) // SMS reminder queries
}

model League {
  id                  String             @id @default(uuid())
  name                String
  code                String             @unique
  type                LeagueType         @default(CUSTOM)
  description         String?
  isPasswordProtected Boolean            @default(false)
  password            String?
  maxPlayers          Int                @default(18)
  currentPlayers      Int                @default(0)
  status              LeagueStatus       @default(OPEN)
  createdBy           String?
  isAdminOnly         Boolean            @default(false)
  draftStatus         DraftStatus        @default(PENDING)
  draftRunAt          DateTime?
  picksPerUser        Int                @default(2)
  rankingLockAt       DateTime?
  // Stripe/Charity fields
  entryFee            Decimal?           @default(0) @db.Decimal(10, 2)
  charityEnabled      Boolean            @default(false)
  charityPercentage   Int?               @default(100) // % of pot to charity
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  seasonId            String?
  DraftPick           DraftPick[]
  season              Season?            @relation(fields: [seasonId], references: [id])
  memberships         LeagueMembership[]
  Pick                Pick[]
  Ranking             Ranking[]
  Score               Score[]
  users               User[]             @relation("LegacyLeague")
  payments            Payment[]
  charityPayouts      CharityPayout[]

  @@index([seasonId])
  @@index([status]) // Filter by league status (OPEN/FULL/etc)
  @@index([draftStatus]) // Filter by draft status
  @@index([type]) // Filter OFFICIAL vs CUSTOM leagues
  @@index([code]) // Fast code lookups (already unique, but explicit)
}

model LeagueMembership {
  id                   String     @id @default(uuid())
  userId               String
  leagueId             String
  role                 MemberRole @default(MEMBER)
  joinedAt             DateTime   @default(now())
  isActive             Boolean    @default(true)
  notificationsEnabled Boolean    @default(true)
  league               League     @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user                 User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, leagueId])
  @@index([userId])
  @@index([leagueId])
}

model Castaway {
  id             String         @id @default(uuid())
  name           String
  number         Int?
  tribe          String?
  occupation     String?
  age            Int?
  hometown       String?
  imageUrl       String?
  eliminated     Boolean        @default(false)
  eliminatedWeek Int?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  seasonId       String?
  season         Season?        @relation(fields: [seasonId], references: [id])
  draftPicks     DraftPick[]
  picks          Pick[]
  RankingEntry   RankingEntry[]
  weeklyResults  WeeklyResult[]

  @@unique([seasonId, number])
  @@index([seasonId])
  @@index([eliminated]) // CEREBRO #03: Filter by elimination status
  @@index([tribe]) // CEREBRO #03: Group by tribe queries
}

model WeeklyResult {
  id         String   @id @default(uuid())
  weekNumber Int
  points     Float
  castawayId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  seasonId   String?
  castaway   Castaway @relation(fields: [castawayId], references: [id])
  season     Season?  @relation(fields: [seasonId], references: [id])

  @@unique([seasonId, weekNumber, castawayId])
  @@index([seasonId])
}

model Pick {
  id             String    @id @default(uuid())
  userId         String
  castawayId     String
  weekNumber     Int
  leagueId       String?
  weekId         String?
  locked         Boolean   @default(false)
  isAutoSelected Boolean   @default(false)
  penaltyApplied Boolean   @default(false)
  submittedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  seasonId       String?
  castaway       Castaway  @relation(fields: [castawayId], references: [id])
  league         League?   @relation(fields: [leagueId], references: [id])
  season         Season?   @relation(fields: [seasonId], references: [id])
  user           User      @relation(fields: [userId], references: [id])
  week           Week?     @relation(fields: [weekId], references: [id])

  @@index([userId, weekNumber])
  @@index([weekNumber])
  @@index([userId])
  @@index([leagueId])
  @@index([leagueId, weekNumber])
  @@index([seasonId])
}

model Week {
  id           String    @id @default(uuid())
  weekNumber   Int
  isActive     Boolean   @default(false)
  lockAt       DateTime?
  picksOpenAt  DateTime?
  picksCloseAt DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  seasonId     String?
  picks        Pick[]
  scores       Score[]
  season       Season?   @relation(fields: [seasonId], references: [id])

  @@unique([seasonId, weekNumber])
  @@index([isActive])
  @@index([picksCloseAt])
  @@index([weekNumber])
  @@index([seasonId])
}

model Ranking {
  id          String         @id @default(uuid())
  userId      String
  leagueId    String?
  submittedAt DateTime       @default(now())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  seasonId    String?
  league      League?        @relation(fields: [leagueId], references: [id])
  season      Season?        @relation(fields: [seasonId], references: [id])
  user        User           @relation(fields: [userId], references: [id])
  entries     RankingEntry[]

  @@unique([userId, leagueId, seasonId])
  @@index([userId])
  @@index([leagueId])
  @@index([seasonId])
}

model RankingEntry {
  id         String   @id @default(uuid())
  rankingId  String
  castawayId String
  position   Int
  createdAt  DateTime @default(now())
  castaway   Castaway @relation(fields: [castawayId], references: [id])
  ranking    Ranking  @relation(fields: [rankingId], references: [id], onDelete: Cascade)

  @@unique([rankingId, position])
  @@unique([rankingId, castawayId])
  @@index([castawayId]) // CEREBRO #15: Lookup rankings for a castaway
}

model DraftPick {
  id         String   @id @default(uuid())
  userId     String
  castawayId String
  leagueId   String
  round      Int
  pickNumber Int
  assignedAt DateTime @default(now())
  seasonId   String?
  castaway   Castaway @relation(fields: [castawayId], references: [id])
  league     League   @relation(fields: [leagueId], references: [id])
  season     Season?  @relation(fields: [seasonId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([leagueId, userId, round])
  @@index([seasonId])
  @@index([castawayId]) // CEREBRO #15: Lookup users who drafted a castaway
  @@index([userId]) // CEREBRO #15: Lookup user's draft picks
  @@index([leagueId]) // Fast league draft pick lookups
}

model Score {
  id        String   @id @default(uuid())
  userId    String
  weekId    String
  leagueId  String?
  points    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  seasonId  String?
  league    League?  @relation(fields: [leagueId], references: [id])
  season    Season?  @relation(fields: [seasonId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  week      Week     @relation(fields: [weekId], references: [id])

  @@unique([userId, weekId])
  @@index([userId])
  @@index([weekId])
  @@index([leagueId])
  @@index([leagueId, weekId])
  @@index([seasonId])
}

model Feedback {
  id         String     @id @default(uuid())
  userId     String
  surveyType SurveyType
  question   String
  answer     String
  rating     Int?
  metadata   Json?
  createdAt  DateTime   @default(now())
  user       User       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([surveyType])
  @@index([createdAt])
}

model SMSLog {
  id           String   @id @default(uuid())
  userId       String?
  phone        String
  direction    String
  command      String?
  inboundText  String?
  outboundText String?
  success      Boolean
  errorMessage String?
  messageId    String?
  credits      Int      @default(0)
  eventKey     String?  @unique
  createdAt    DateTime @default(now())
  user         User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([phone])
  @@index([createdAt])
  @@index([command])
  @@index([eventKey])
}

enum SeasonStatus {
  COLLECTING
  DRAFT_WEEK
  ACTIVE
  GRACE
  ARCHIVED
}

enum LeagueType {
  OFFICIAL
  CUSTOM
}

enum LeagueStatus {
  OPEN
  FULL
  ACTIVE
  COMPLETED
}

enum DraftStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum MemberRole {
  ADMIN
  MEMBER
}

enum SurveyType {
  PRESEASON_RANKING
  WEEKLY_PICKS
  LEADERBOARD
  PROFILE
  BETA_FEEDBACK
}

enum SessionStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// =============================================================================
// CEREBRO #03: Denormalized leaderboard cache for O(1) queries
// =============================================================================
model LeaderboardCache {
  id           String @id @default(uuid())
  userId       String
  leagueId     String
  seasonId     String
  totalScore   Int    @default(0)
  rank         Int?
  weeksPlayed  Int    @default(0)
  weeksInFirst Int    @default(0) // Tracks weeks player was ranked #1

  lastUpdated DateTime @default(now())

  @@unique([userId, leagueId, seasonId])
  @@index([leagueId, totalScore(sort: Desc)]) // Fast sorted leaderboard by league
  @@index([seasonId, totalScore(sort: Desc)]) // Global season leaderboard
  @@index([userId])
}

// =============================================================================
// CEREBRO #09: Stripe Payments & Charity Donations
// =============================================================================
model Payment {
  id              String        @id @default(uuid())
  userId          String
  leagueId        String
  amount          Decimal       @db.Decimal(10, 2)
  stripePaymentId String        @unique
  stripeSessionId String?       @unique
  status          PaymentStatus @default(PENDING)
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  league League @relation(fields: [leagueId], references: [id])

  @@index([userId])
  @@index([leagueId])
  @@index([status])
  @@index([stripePaymentId])
}

model CharityPayout {
  id            String       @id @default(uuid())
  leagueId      String
  winnerUserId  String
  charityName   String
  charityUrl    String?
  amount        Decimal      @db.Decimal(10, 2)
  payoutStatus  PayoutStatus @default(PENDING)
  paidAt        DateTime?
  paidByAdminId String?
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  league League @relation(fields: [leagueId], references: [id])
  winner User   @relation(fields: [winnerUserId], references: [id])

  @@index([leagueId])
  @@index([winnerUserId])
  @@index([payoutStatus])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PayoutStatus {
  PENDING
  PAID
  CANCELLED
}
