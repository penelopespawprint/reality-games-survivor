# RGFL Survivor Multi-League Deployment Guide

## Overview
This application is configured to deploy to **test.realitygamesfantasyleague.com** using Render.

## Database Configuration
- **Database Host**: dpg-d4kbb5k9c44c73erlpp0-a.oregon-postgres.render.com
- **Database Name**: rgfl_survivor_ml
- **Database User**: rgfl_survivor_ml_user
- **Connection String**: Already configured in render.yaml

## Deployment Steps

### Option 1: Deploy via Render Dashboard (Recommended)

1. **Log in to Render**: https://dashboard.render.com

2. **Create New Web Service**:
   - Click "New +" → "Web Service"
   - Connect your GitHub repository: `https://github.com/penelopespawprint/rgfl-multi.git`
   - Use the following settings:
     - **Name**: `rgfl-multi`
     - **Environment**: `Node`
     - **Build Command**: `npm install && npx prisma generate && npm run build`
     - **Start Command**: `npm start`

3. **Environment Variables** (already configured in render.yaml):
   - `NODE_ENV`: production
   - `DATABASE_URL`: postgresql://rgfl_survivor_ml_user:yhyJlseYWgor248l8jcb70hFMsdoLB1K@dpg-d4kbb5k9c44c73erlpp0-a.oregon-postgres.render.com/rgfl_survivor_ml?sslmode=require
   - `PORT`: 5050
   - `CLIENT_ORIGIN`: https://test.realitygamesfantasyleague.com
   - `CLIENT_URL`: https://test.realitygamesfantasyleague.com
   - `JWT_SECRET`: (auto-generated by Render)
   - `SESSION_SECRET`: (auto-generated by Render)
   - Optional: SMTP and Twilio credentials for email/SMS features

4. **Custom Domain**:
   - In Render Dashboard → Your Service → Settings → Custom Domains
   - Add `test.realitygamesfantasyleague.com`
   - Update DNS records as instructed by Render:
     - Add CNAME record: `test` → `rgfl-survivor-ml.onrender.com`

5. **Deploy**:
   - Click "Create Web Service"
   - Render will automatically build and deploy

### Option 2: Deploy via render.yaml (Blueprint)

1. **Push to GitHub**:
   ```bash
   git push origin main
   ```

2. **Create from Blueprint**:
   - In Render Dashboard → Blueprints
   - Click "New Blueprint Instance"
   - Connect to GitHub repo
   - Render will read `render.yaml` and create the service automatically

## Post-Deployment Setup

### 1. Seed Initial Data
After first deployment, seed the database with initial league data:

```bash
# SSH into Render instance or run via Render Shell
npm run db:seed
```

Or run the SQL seed file directly:
```bash
psql postgresql://rgfl_survivor_ml_user:yhyJlseYWgor248l8jcb70hFMsdoLB1K@dpg-d4kbb5k9c44c73erlpp0-a.oregon-postgres.render.com/rgfl_survivor_ml < prisma/seed-multi-league.sql
```

### 2. Create Admin User
Create an admin user for managing the platform:

```bash
# Via Render Shell or local connection to production DB
npx tsx server/scripts/create-admin.ts
```

### 3. Verify Deployment
Test the following URLs:
- Main site: https://test.realitygamesfantasyleague.com
- Health check: https://test.realitygamesfantasyleague.com/api/health
- Leagues API: https://test.realitygamesfantasyleague.com/api/leagues/my-leagues

## Monitoring

### Logs
View logs in Render Dashboard → Your Service → Logs

### Database
- Use Render's built-in database dashboard
- Or connect via psql:
  ```bash
  psql postgresql://rgfl_survivor_ml_user:yhyJlseYWgor248l8jcb70hFMsdoLB1K@dpg-d4kbb5k9c44c73erlpp0-a.oregon-postgres.render.com/rgfl_survivor_ml
  ```

## Troubleshooting

### Build Failures
- Check that `prisma generate` runs successfully
- Ensure all dependencies are in `package.json`, not just `devDependencies`
- Verify TypeScript compilation with `npm run check`

### Database Connection Issues
- Verify DATABASE_URL includes `?sslmode=require`
- Check that database is in same region as web service for best performance
- Ensure database accepts connections from Render IPs

### 404 Errors on Routes
- Ensure server serves `dist/public/index.html` for all routes
- Check that `server/index.ts` has the catch-all route handler

### Multi-League Features Not Working
- Verify that users are auto-assigned to Official League on signup
- Check that LeagueContext is properly initialized in browser
- Ensure league-scoped API endpoints are returning data

## Environment Variables Reference

| Variable | Required | Description |
|----------|----------|-------------|
| NODE_ENV | Yes | Set to "production" |
| DATABASE_URL | Yes | PostgreSQL connection string |
| PORT | Yes | Port number (5050) |
| CLIENT_ORIGIN | Yes | Frontend URL for CORS |
| CLIENT_URL | Yes | Frontend URL for emails |
| JWT_SECRET | Yes | Secret for JWT tokens (auto-generated) |
| SESSION_SECRET | Yes | Secret for sessions (auto-generated) |
| SMTP_HOST | No | SMTP server for emails |
| SMTP_PORT | No | SMTP port (587) |
| SMTP_USER | No | SMTP username |
| SMTP_PASS | No | SMTP password |
| SMTP_FROM | No | From email address |
| TWILIO_ACCOUNT_SID | No | Twilio account SID for SMS |
| TWILIO_AUTH_TOKEN | No | Twilio auth token |
| TWILIO_PHONE_NUMBER | No | Twilio phone number |

## Rollback Procedure

If deployment fails:
1. In Render Dashboard → Deployments
2. Click on previous successful deployment
3. Click "Redeploy"

## Local Testing of Production Build

Test the production build locally before deploying:

```bash
# Build the app
npm run build

# Start in production mode
NODE_ENV=production npm start

# Visit http://localhost:5050
```

## Auto-Deployment

The service is configured with `autoDeploy: true`, so pushing to the `main` branch will automatically trigger a deployment.

To disable auto-deploy:
- Render Dashboard → Your Service → Settings → Auto-Deploy
- Toggle off

## Support

For issues:
1. Check Render logs for errors
2. Review this deployment guide
3. Check PROGRESS.md for known issues
4. Contact: richard@realitygamesfantasyleague.com
