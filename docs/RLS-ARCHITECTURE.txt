================================================================================
ROW LEVEL SECURITY (RLS) ARCHITECTURE
Survivor Fantasy League - Database Security Model
================================================================================

CLIENT LAYERS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         WEB FRONTEND (React)                            â”‚
â”‚                    Uses: Anon Client (RLS Enforced)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       EXPRESS API (Backend)                             â”‚
â”‚              Uses: Service Role Client (RLS Bypassed)                   â”‚
â”‚              â€¢ Validates business rules before writes                   â”‚
â”‚              â€¢ Uses service role for all mutations                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUPABASE POSTGRESQL + RLS                            â”‚
â”‚                       24 Tables, 3 Access Levels                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================
RLS POLICY ARCHITECTURE
================================================================================

ACCESS LEVEL 1: PUBLIC DATA (Read-Only for All Authenticated Users)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… seasons            SELECT for all â†’ true
âœ… episodes           SELECT for all â†’ true
âœ… castaways          SELECT for all â†’ true
âœ… scoring_rules      SELECT for all â†’ true

Policy Example:
  CREATE POLICY seasons_select_all ON seasons
    FOR SELECT USING (true);


ACCESS LEVEL 2: USER-OWNED DATA (Own Data Only)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… notifications      SELECT/UPDATE â†’ user_id = auth.uid()
âœ… sms_commands       SELECT â†’ user_id = auth.uid()
âœ… payments           SELECT â†’ user_id = auth.uid()
âœ… draft_rankings     CRUD â†’ user_id = auth.uid()
âœ… waiver_rankings    CRUD â†’ user_id = auth.uid()
âœ… notification_prefs SELECT/UPDATE/INSERT â†’ user_id = auth.uid()
âœ… results_tokens     SELECT â†’ user_id = auth.uid()

Policy Example:
  CREATE POLICY notifications_select_own ON notifications
    FOR SELECT USING (user_id = (SELECT auth.uid()));


ACCESS LEVEL 3: LEAGUE-SCOPED DATA (Visible to League Members)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… rosters            SELECT â†’ is_league_member(league_id)
                      INSERT/UPDATE â†’ user_id = auth.uid()

âœ… weekly_picks       SELECT (locked) â†’ is_league_member(league_id)
                      SELECT (pending) â†’ user_id = auth.uid()
                      INSERT/UPDATE â†’ SERVICE ROLE ONLY (via trigger)

âœ… league_members     SELECT â†’ is_league_member(league_id)
                      INSERT â†’ user_id = auth.uid()
                      DELETE â†’ user_id = auth.uid()

âœ… league_messages    SELECT/INSERT â†’ is_league_member(league_id)
                      DELETE â†’ user_id = auth.uid()

âœ… waiver_results     SELECT â†’ is_league_member(league_id)

Helper Function:
  CREATE FUNCTION is_league_member(league_uuid UUID)
  RETURNS BOOLEAN AS $$
    SELECT EXISTS (
      SELECT 1 FROM league_members
      WHERE league_id = league_uuid
        AND user_id = (SELECT auth.uid())
    )
  $$ LANGUAGE SQL STABLE SECURITY DEFINER;


ACCESS LEVEL 4: ADMIN-CONTROLLED DATA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… episode_scores     SELECT â†’ status = 'finalized'
                      INSERT/UPDATE/DELETE â†’ is_admin() OR service_role

âœ… scoring_sessions   SELECT â†’ status = 'finalized'
                      INSERT/UPDATE/DELETE â†’ is_admin() OR service_role

âœ… announcements      SELECT â†’ is_active AND not expired
                      INSERT/UPDATE/DELETE â†’ is_admin() OR service_role

Helper Function:
  CREATE FUNCTION is_admin()
  RETURNS BOOLEAN AS $$
    SELECT EXISTS (
      SELECT 1 FROM users
      WHERE id = (SELECT auth.uid())
        AND role = 'admin'
    )
  $$ LANGUAGE SQL STABLE SECURITY DEFINER;


ACCESS LEVEL 5: SERVICE-ONLY DATA (Infrastructure)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… email_queue        ALL â†’ service_role ONLY (admin can SELECT)
âœ… failed_emails      ALL â†’ service_role ONLY (admin can SELECT)
âœ… cron_job_logs      ALL â†’ service_role OR is_admin()
âœ… verification_codes ALL â†’ service_role ONLY (security - no user access)

Policy Example:
  CREATE POLICY email_queue_service_only ON email_queue
    FOR ALL USING ((SELECT auth.role()) = 'service_role');


ACCESS LEVEL 6: HARDENED WITH TRIGGERS (Extra Protection)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… weekly_picks       TRIGGER validates:
                      â€¢ Only service_role can INSERT/UPDATE
                      â€¢ Castaway must be on user's roster
                      â€¢ Castaway must be active (not eliminated)
                      â€¢ Episode must not be locked
                      â€¢ User must be league member

Trigger:
  CREATE TRIGGER validate_weekly_pick_trigger
    BEFORE INSERT OR UPDATE ON weekly_picks
    FOR EACH ROW
    EXECUTE FUNCTION validate_weekly_pick();

  Function raises exception if validation fails:
    RAISE EXCEPTION 'Castaway is not on your roster';


SERVICE ROLE BYPASS (All Tables)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Every table has this policy:

  CREATE POLICY service_bypass_[table_name] ON [table_name]
    FOR ALL USING ((SELECT auth.role()) = 'service_role');

Why?
  â€¢ Backend needs to perform system operations
  â€¢ Auto-pick job updates all users' picks
  â€¢ Draft finalization writes across users
  â€¢ Email queue processing
  â€¢ Scoring finalization

================================================================================
SECURITY BOUNDARIES
================================================================================

FRONTEND (Anon Client)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… CAN:
  â€¢ Read public data (seasons, episodes, castaways, scoring_rules)
  â€¢ Read own private data (notifications, picks, payments)
  â€¢ Read league data (rosters, locked picks in same league)
  â€¢ Read finalized scores
  â€¢ Insert own data (draft_rankings, league_members if not paid)

âŒ CANNOT:
  â€¢ Read other users' private data
  â€¢ Read infrastructure tables (email_queue, cron_job_logs)
  â€¢ Write to weekly_picks (must use API)
  â€¢ Read password hashes (if properly queried)
  â€¢ Read pending picks of other users


BACKEND API (Service Role)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… CAN:
  â€¢ Everything (bypasses all RLS)
  â€¢ System operations (auto-pick, draft, scoring)
  â€¢ Cross-user operations
  â€¢ Infrastructure table access

âŒ MUST:
  â€¢ Validate business rules before writes
  â€¢ Never expose service key to frontend
  â€¢ Use service role for ALL mutations
  â€¢ Validate user permissions before operations


ADMIN DASHBOARD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… CAN:
  â€¢ View all data (via is_admin() function)
  â€¢ Manage seasons, episodes, castaways
  â€¢ Finalize scoring
  â€¢ View job logs
  â€¢ Debug email queue (read only)

âŒ CANNOT:
  â€¢ Modify email queue directly
  â€¢ Access without admin role


================================================================================
TESTING MATRIX
================================================================================

Test Case                           | Expected Result              | Status
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User A reads User B notifications   | Empty / Error                | âœ…
User A reads User B payments        | Empty / Error                | âœ…
User A reads User B pending picks   | Empty / Error                | âœ…
User A reads public seasons         | Success (all seasons)        | âœ…
User A reads league mate roster     | Success (if same league)     | âœ…
User A reads email_queue            | Empty / Error                | âœ… (after fix)
User A inserts weekly_pick directly | Error (must use API)         | âœ…
Service role reads all users        | Success (all users)          | âœ…
Service role updates any pick       | Success                      | âœ…
Admin reads cron_job_logs           | Success (all logs)           | âœ…
Non-admin reads cron_job_logs       | Empty / Error                | âœ… (after fix)
Frontend queries leagues            | Success (no password_hash)   | âœ… (after fix)

================================================================================
VULNERABILITY SUMMARY
================================================================================

BEFORE FIXES:
ğŸ”´ email_queue          â†’ NO RLS (anyone can read all emails)
ğŸ”´ failed_emails        â†’ NO RLS (anyone can read failures)
ğŸ”´ cron_job_logs        â†’ NO RLS (anyone can see system logs)
âš ï¸  leagues (frontend)  â†’ SELECT '*' exposes password_hash
âš ï¸  notification_prefs  â†’ Missing INSERT policy
âš ï¸  results_tokens      â†’ Missing service bypass

AFTER FIXES:
âœ… email_queue          â†’ Service-only + admin read
âœ… failed_emails        â†’ Service-only + admin read
âœ… cron_job_logs        â†’ Service/admin only
âœ… leagues (frontend)   â†’ Explicit columns (no password_hash)
âœ… notification_prefs   â†’ Full CRUD + service bypass
âœ… results_tokens       â†’ User read + service bypass + admin

================================================================================
DEPLOYMENT STEPS
================================================================================

1. Apply Migration 027 (Infrastructure RLS)
   npx supabase db push --file supabase/migrations/027_fix_infrastructure_rls.sql

2. Apply Migration 028 (Complete Policies)
   npx supabase db push --file supabase/migrations/028_complete_missing_rls_policies.sql

3. Fix Frontend Queries
   â€¢ web/src/pages/EpisodeResults.tsx:79
   â€¢ web/src/pages/Leaderboard.tsx:60
   Change: .select('*') â†’ .select('id, name, code, ...')

4. Run Test Suite
   npx tsx server/src/tests/rls-security-test.ts

5. Verify in Production
   â€¢ Test with multiple users
   â€¢ Verify data isolation
   â€¢ Check admin dashboard
   â€¢ Monitor error logs

================================================================================
REFERENCE FILES
================================================================================

ğŸ“„ Full Report:           /QA-REPORT-RLS-SECURITY.md (4,500+ lines)
ğŸ“„ Executive Summary:     /RLS-SECURITY-SUMMARY.md
ğŸ“„ Best Practices:        /server/docs/RLS-BEST-PRACTICES.md
ğŸ”§ Migration 027:         /supabase/migrations/027_fix_infrastructure_rls.sql
ğŸ”§ Migration 028:         /supabase/migrations/028_complete_missing_rls_policies.sql
ğŸ§ª Test Suite:            /server/src/tests/rls-security-test.ts

================================================================================
